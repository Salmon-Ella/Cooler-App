#:import ZBarCam kivy_garden.zbarcam.ZBarCam 
#:import MDSwipeToDismissItem kivymd.uix.list.MDSwipeToDismissItem
#:import AsyncImage kivy.uix.image.AsyncImage
#:import TwoLineListItem kivymd.uix.list.TwoLineListItem
#:import MDSpinner kivymd.uix.spinner.MDSpinner

ScreenManager:
    id: manager

    MDScreen:
        name: 'main_list_screen'
        MDBoxLayout:
            orientation: 'vertical'

            MDToolbar:
                title: "Missing Inventory List"
                elevation: 10

            RecycleView:
                id: missing_list_rv
                viewclass: 'MissingItem'
                RecycleBoxLayout:
                    default_size: None, dp(64)
                    default_size_hint: 1, None
                    orientation: 'vertical'
                    size_hint_y: None
                    height: self.minimum_height
                    padding: dp(10)
                    spacing: dp(10)

            MDBoxLayout:
                size_hint_y: None
                height: "56dp"
                padding: "8dp"

                MDRaisedButton:
                    text: "Clear All"
                    on_release: app.show_clear_dialog() 
                    size_hint_x: 0.4

                Widget: 

                MDFloatingActionButton:
                    icon: "barcode-scan"
                    on_release: app.go_to_scanner_screen()

    MDScreen:
        name: 'scanner_screen'
        MDBoxLayout:
            orientation: 'vertical'
            
            MDToolbar:
                title: "Scan Missing Item"
                left_action_items: [['arrow-left', lambda x: app.go_to_main_screen()]]

            ZBarCam: 
                id: scanner
                on_code: app.handle_barcode_scan(self.code[0]) 

    MDScreen:
        name: 'loading_screen'
        MDBoxLayout:
            orientation: 'vertical'
            MDToolbar:
                title: "Looking Up Product..."
            MDBoxLayout:
                orientation: 'vertical'
                padding: "20dp"
                spacing: "20dp"
                pos_hint: {'center_x': 0.5, 'center_y': 0.5}
                MDSpinner:
                    id: loading_spinner
                    size_hint: None, None
                    size: dp(46), dp(46)
                    pos_hint: {'center_x': 0.5}
                MDLabel:
                    text: "Contacting online catalog..."
                    halign: 'center'

# --- Custom List Item Definition ---
<MissingItem@MDSwipeToDismissItem>:
    text: ''
    secondary_text: ''
    source: ''
    barcode_id: ''
    
    on_dismiss: app.remove_found_item(root.barcode_id)
    
    MDBoxLayout:
        size_hint_y: None
        height: dp(64)
        padding: dp(5)
        
        AsyncImage: 
            source: root.source
            size_hint_x: None
            width: dp(48)
            pos_hint: {'center_y': .5}
            radius: [dp(4)]
            allow_stretch: True
            keep_ratio: True

        TwoLineListItem:
            text: root.text
            secondary_text: root.secondary_text
            _no_ripple_effect: True
